"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.hightlightLines = exports.isEqualArray = void 0;
function isEqualArray(a, b) {
    if (a.length !== b.length)
        return false;
    for (let i = 0; i < a.length; i++) {
        if (a[i] !== b[i])
            return false;
    }
    return true;
}
exports.isEqualArray = isEqualArray;
function escapeChar(match) {
    switch (match) {
        case '&':
            return '&amp;';
        case '"':
            return '&quot;';
        case "'":
            return '&#39;';
        case '<':
            return '&lt;';
        case '>':
            return '&gt;';
        case ' ':
            return '&nbsp;';
        default:
            return match;
    }
}
function escapeString(inp) {
    return inp.replace(/[&"'<>]/g, escapeChar);
}
function escapeStringNbsp(inp) {
    return inp.replace(/[&"'<> ]/g, escapeChar);
}
function pushScope(scopeStack, scope, html) {
    scopeStack.push(scope);
    html.push(`<span class="${scope.replace(/\.+/g, ' ')}">`);
}
function popScope(scopeStack, html) {
    scopeStack.pop();
    html.push('</span>');
}
function updateScopeStack(scopeStack, desiredScopes, html) {
    let excessScopes = scopeStack.length - desiredScopes.length;
    if (excessScopes > 0)
        while (excessScopes--)
            popScope(scopeStack, html);
    let lasti = 0;
    for (let i = scopeStack.length; i >= 0; --i) {
        if (isEqualArray(scopeStack.slice(0, i), desiredScopes.slice(0, i))) {
            lasti = i;
            break;
        }
        popScope(scopeStack, html);
    }
    for (let j = lasti; j < desiredScopes.length; ++j) {
        pushScope(scopeStack, desiredScopes[j], html);
    }
}
function* hightlightLines(lines, scopeName, nullScope, nbsp) {
    const registry = atom.grammars.textmateRegistry || atom.grammars;
    if (!registry)
        throw new Error('No Atom grammar registry found');
    const grammar = registry.grammarForScopeName(scopeName) ||
        (nullScope ? registry.grammarForScopeName(nullScope) : undefined);
    if (!grammar) {
        throw new Error(`Grammar ${scopeName} not found, and no ${nullScope} grammar`);
    }
    const escape = nbsp ? escapeStringNbsp : escapeString;
    const lit = lines[Symbol.iterator]();
    let line = lit.next();
    let stack = null;
    const scopeStack = [];
    while (!line.done) {
        const tokens = grammar.tokenizeLine(line.value, stack);
        stack = tokens.ruleStack;
        const res = [];
        for (const { value, scopes } of tokens.tokens) {
            const newScopes = scopes.map((s) => `syntax--${s.replace(/\./g, '.syntax--')}`);
            updateScopeStack(scopeStack, newScopes, res);
            res.push(escape(value));
        }
        while (scopeStack.length > 0)
            popScope(scopeStack, res);
        yield res.join('');
        line = lit.next();
    }
}
exports.hightlightLines = hightlightLines;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2hpZ2hsaWdodC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSxTQUFnQixZQUFZLENBQUksQ0FBTSxFQUFFLENBQU07SUFDNUMsSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxNQUFNO1FBQUUsT0FBTyxLQUFLLENBQUE7SUFDdkMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDakMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUFFLE9BQU8sS0FBSyxDQUFBO0tBQ2hDO0lBQ0QsT0FBTyxJQUFJLENBQUE7QUFDYixDQUFDO0FBTkQsb0NBTUM7QUFFRCxTQUFTLFVBQVUsQ0FBQyxLQUFhO0lBQy9CLFFBQVEsS0FBSyxFQUFFO1FBQ2IsS0FBSyxHQUFHO1lBQ04sT0FBTyxPQUFPLENBQUE7UUFDaEIsS0FBSyxHQUFHO1lBQ04sT0FBTyxRQUFRLENBQUE7UUFDakIsS0FBSyxHQUFHO1lBQ04sT0FBTyxPQUFPLENBQUE7UUFDaEIsS0FBSyxHQUFHO1lBQ04sT0FBTyxNQUFNLENBQUE7UUFDZixLQUFLLEdBQUc7WUFDTixPQUFPLE1BQU0sQ0FBQTtRQUNmLEtBQUssR0FBRztZQUNOLE9BQU8sUUFBUSxDQUFBO1FBQ2pCO1lBQ0UsT0FBTyxLQUFLLENBQUE7S0FDZjtBQUNILENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxHQUFXO0lBQy9CLE9BQU8sR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUE7QUFDNUMsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsR0FBVztJQUNuQyxPQUFPLEdBQUcsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLFVBQVUsQ0FBQyxDQUFBO0FBQzdDLENB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TUFBTSxDQUFDLFNBQVMsQ0FBQTtRQUN4QixNQUFNLEdBQUcsR0FBYSxFQUFFLENBQUE7UUFDeEIsS0FBSyxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxJQUFJLE1BQU0sQ0FBQyxNQUFNLEVBQUU7WUFDN0MsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FDMUIsQ0FBQyxDQUFTLEVBQUUsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLEVBQUUsQ0FDMUQsQ0FBQTtZQUNELGdCQUFnQixDQUFDLFVBQVUsRUFBRSxTQUFTLEVBQUUsR0FBRyxDQUFDLENBQUE7WUFDNUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtTQUN4QjtRQUNELE9BQU8sVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDO1lBQUUsUUFBUSxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsQ0FBQTtRQUN2RCxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDbEIsSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQTtLQUNsQjtBQUNILENBQUM7QUF4Q0QsMENBd0NDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR3JhbW1hclJ1bGUsIFRva2VuaXplTGluZVJlc3VsdCB9IGZyb20gJ2F0b20nXG5cbmV4cG9ydCBmdW5jdGlvbiBpc0VxdWFsQXJyYXk8VD4oYTogVFtdLCBiOiBUW10pOiBib29sZWFuIHtcbiAgaWYgKGEubGVuZ3RoICE9PSBiLmxlbmd0aCkgcmV0dXJuIGZhbHNlXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKykge1xuICAgIGlmIChhW2ldICE9PSBiW2ldKSByZXR1cm4gZmFsc2VcbiAgfVxuICByZXR1cm4gdHJ1ZVxufVxuXG5mdW5jdGlvbiBlc2NhcGVDaGFyKG1hdGNoOiBzdHJpbmcpOiBzdHJpbmcge1xuICBzd2l0Y2ggKG1hdGNoKSB7XG4gICAgY2FzZSAnJic6XG4gICAgICByZXR1cm4gJyZhbXA7J1xuICAgIGNhc2UgJ1wiJzpcbiAgICAgIHJldHVybiAnJnF1b3Q7J1xuICAgIGNhc2UgXCInXCI6XG4gICAgICByZXR1cm4gJyYjMzk7J1xuICAgIGNhc2UgJzwnOlxuICAgICAgcmV0dXJuICcmbHQ7J1xuICAgIGNhc2UgJz4nOlxuICAgICAgcmV0dXJuICcmZ3Q7J1xuICAgIGNhc2UgJyAnOlxuICAgICAgcmV0dXJuICcmbmJzcDsnXG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiBtYXRjaFxuICB9XG59XG5cbmZ1bmN0aW9uIGVzY2FwZVN0cmluZyhpbnA6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBpbnAucmVwbGFjZSgvWyZcIic8Pl0vZywgZXNjYXBlQ2hhcilcbn1cblxuZnVuY3Rpb24gZXNjYXBlU3RyaW5nTmJzcChpbnA6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBpbnAucmVwbGFjZSgvWyZcIic8PiBdL2csIGVzY2FwZUNoYXIpXG59XG5cbmZ1bmN0aW9uIHB1c2hTY29wZShzY29wZVN0YWNrOiBzdHJpbmdbXSwgc2NvcGU6IHN0cmluZywgaHRtbDogc3RyaW5nW10pOiB2b2lkIHtcbiAgc2NvcGVTdGFjay5wdXNoKHNjb3BlKVxuICBodG1sLnB1c2goYDxzcGFuIGNsYXNzPVwiJHtzY29wZS5yZXBsYWNlKC9cXC4rL2csICcgJyl9XCI+YClcbn1cblxuZnVuY3Rpb24gcG9wU2NvcGUoc2NvcGVTdGFjazogc3RyaW5nW10sIGh0bWw6IHN0cmluZ1tdKTogdm9pZCB7XG4gIHNjb3BlU3RhY2sucG9wKClcbiAgaHRtbC5wdXNoKCc8L3NwYW4+Jylcbn1cblxuZnVuY3Rpb24gdXBkYXRlU2NvcGVTdGFjayhcbiAgc2NvcGVTdGFjazogc3RyaW5nW10sXG4gIGRlc2lyZWRTY29wZXM6IHN0cmluZ1tdLFxuICBodG1sOiBzdHJpbmdbXSxcbik6IHZvaWQge1xuICBsZXQgZXhjZXNzU2NvcGVzID0gc2NvcGVTdGFjay5sZW5ndGggLSBkZXNpcmVkU2NvcGVzLmxlbmd0aFxuICBpZiAoZXhjZXNzU2NvcGVzID4gMCkgd2hpbGUgKGV4Y2Vzc1Njb3Blcy0tKSBwb3BTY29wZShzY29wZVN0YWNrLCBodG1sKVxuXG4gIC8vIHBvcCB1bnRpbCBjb21tb24gcHJlZml4XG4gIGxldCBsYXN0aSA9IDBcbiAgZm9yIChsZXQgaSA9IHNjb3BlU3RhY2subGVuZ3RoOyBpID49IDA7IC0taSkge1xuICAgIGlmIChpc0VxdWFsQXJyYXkoc2NvcGVTdGFjay5zbGljZSgwLCBpKSwgZGVzaXJlZFNjb3Blcy5zbGljZSgwLCBpKSkpIHtcbiAgICAgIGxhc3RpID0gaVxuICAgICAgYnJlYWtcbiAgICB9XG4gICAgcG9wU2NvcGUoc2NvcGVTdGFjaywgaHRtbClcbiAgfVxuICAvLyBwdXNoIG9uIHRvcCBvZiBjb21tb24gcHJlZml4IHVudGlsIHNjb3BlU3RhY2sgaXMgZGVzaXJlZFNjb3Blc1xuICBmb3IgKGxldCBqID0gbGFzdGk7IGogPCBkZXNpcmVkU2NvcGVzLmxlbmd0aDsgKytqKSB7XG4gICAgcHVzaFNjb3BlKHNjb3BlU3RhY2ssIGRlc2lyZWRTY29wZXNbal0sIGh0bWwpXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uKiBoaWdodGxpZ2h0TGluZXMoXG4gIGxpbmVzOiBJdGVyYWJsZTxzdHJpbmc+LFxuICBzY29wZU5hbWU6IHN0cmluZyxcbiAgbnVsbFNjb3BlPzogc3RyaW5nLFxuICBuYnNwPzogYm9vbGVhbixcbik6IEl0ZXJhYmxlSXRlcmF0b3I8c3RyaW5nPiB7XG4gIGNvbnN0IHJlZ2lzdHJ5ID0gYXRvbS5ncmFtbWFycy50ZXh0bWF0ZVJlZ2lzdHJ5IHx8IGF0b20uZ3JhbW1hcnNcbiAgaWYgKCFyZWdpc3RyeSkgdGhyb3cgbmV3IEVycm9yKCdObyBBdG9tIGdyYW1tYXIgcmVnaXN0cnkgZm91bmQnKVxuICBjb25zdCBncmFtbWFyID1cbiAgICByZWdpc3RyeS5ncmFtbWFyRm9yU2NvcGVOYW1lKHNjb3BlTmFtZSkgfHxcbiAgICAobnVsbFNjb3BlID8gcmVnaXN0cnkuZ3JhbW1hckZvclNjb3BlTmFtZShudWxsU2NvcGUpIDogdW5kZWZpbmVkKVxuICBpZiAoIWdyYW1tYXIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgR3JhbW1hciAke3Njb3BlTmFtZX0gbm90IGZvdW5kLCBhbmQgbm8gJHtudWxsU2NvcGV9IGdyYW1tYXJgLFxuICAgIClcbiAgfVxuXG4gIGNvbnN0IGVzY2FwZSA9IG5ic3AgPyBlc2NhcGVTdHJpbmdOYnNwIDogZXNjYXBlU3RyaW5nXG5cbiAgY29uc3QgbGl0ID0gbGluZXNbU3ltYm9sLml0ZXJhdG9yXSgpXG5cbiAgbGV0IGxpbmUgPSBsaXQubmV4dCgpXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tbnVsbC1rZXl3b3JkXG4gIGxldCBzdGFjazogR3JhbW1hclJ1bGVbXSA9IG51bGwgYXMgYW55XG4gIGNvbnN0IHNjb3BlU3RhY2s6IHN0cmluZ1tdID0gW11cbiAgd2hpbGUgKCFsaW5lLmRvbmUpIHtcbiAgICBjb25zdCB0b2tlbnM6IFRva2VuaXplTGluZVJlc3VsdCA9IGdyYW1tYXIudG9rZW5pemVMaW5lKGxpbmUudmFsdWUsIHN0YWNrKVxuICAgIHN0YWNrID0gdG9rZW5zLnJ1bGVTdGFja1xuICAgIGNvbnN0IHJlczogc3RyaW5nW10gPSBbXVxuICAgIGZvciAoY29uc3QgeyB2YWx1ZSwgc2NvcGVzIH0gb2YgdG9rZW5zLnRva2Vucykge1xuICAgICAgY29uc3QgbmV3U2NvcGVzID0gc2NvcGVzLm1hcChcbiAgICAgICAgKHM6IHN0cmluZykgPT4gYHN5bnRheC0tJHtzLnJlcGxhY2UoL1xcLi9nLCAnLnN5bnRheC0tJyl9YCxcbiAgICAgIClcbiAgICAgIHVwZGF0ZVNjb3BlU3RhY2soc2NvcGVTdGFjaywgbmV3U2NvcGVzLCByZXMpXG4gICAgICByZXMucHVzaChlc2NhcGUodmFsdWUpKVxuICAgIH1cbiAgICB3aGlsZSAoc2NvcGVTdGFjay5sZW5ndGggPiAwKSBwb3BTY29wZShzY29wZVN0YWNrLCByZXMpXG4gICAgeWllbGQgcmVzLmpvaW4oJycpXG4gICAgbGluZSA9IGxpdC5uZXh0KClcbiAgfVxufVxuIl19